<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00d9ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–°–º–µ–Ω—ã">
    <link rel="apple-touch-icon" href="/icon-192.png">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW error:', err));
            });
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            font-size: 14px;
        }

        /* ==================== LOGIN ==================== */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 15px;
        }

        .login-box {
            background: rgba(255,255,255,0.1);
            padding: 30px 20px;
            border-radius: 16px;
            width: 100%;
            max-width: 340px;
            backdrop-filter: blur(10px);
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 8px;
            font-size: 1.5rem;
        }

        .login-box p {
            text-align: center;
            color: #888;
            margin-bottom: 20px;
            font-size: 0.85rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #aaa;
            font-size: 0.8rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: 2px solid #00d9ff;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            color: #1a1a2e;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
        }

        .login-error {
            background: rgba(255, 71, 87, 0.2);
            color: #ff6b6b;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
            font-size: 0.85rem;
        }

        /* ==================== MAIN APP ==================== */
        .app-screen {
            display: none;
            padding: 10px;
            padding-bottom: 65px;
        }

        .app-screen.active {
            display: block;
        }

        .login-screen.hidden {
            display: none;
        }

        /* Header */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .app-header h1 {
            font-size: 1.1rem;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-badge {
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255, 71, 87, 0.2);
            color: #ff6b6b;
            border: none;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            background: rgba(255,255,255,0.1);
            padding: 6px 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-group label {
            font-size: 0.7rem;
            color: #aaa;
            white-space: nowrap;
        }

        input, select, button {
            padding: 8px 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
        }

        input, select {
            background: rgba(255,255,255,0.15);
            color: #fff;
        }

        button {
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
            min-height: 34px;
        }

        .btn-excel {
            background: linear-gradient(135deg, #2ed573, #1e90ff);
            font-size: 0.75rem;
            padding: 8px 12px;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #576574, #8395a7);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #ff6b81);
        }

        /* Sections */
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 12px;
        }

        .section h2 {
            font-size: 0.85rem;
            margin-bottom: 10px;
            color: #00d9ff;
        }

        /* ==================== COLLAPSIBLE SECTION ==================== */
        .section-collapsible {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .section-header:hover {
            background: rgba(255,255,255,0.05);
        }

        .section-header:active {
            background: rgba(255,255,255,0.08);
        }

        .section-header h2 {
            font-size: 0.85rem;
            margin: 0;
            color: #00d9ff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header .employee-count {
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: normal;
        }

        .section-toggle {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s, background 0.2s;
        }

        .section-toggle::before {
            content: '‚ñº';
            font-size: 0.65rem;
            color: #aaa;
            transition: transform 0.3s;
        }

        .section-collapsible.expanded .section-toggle {
            background: rgba(0, 217, 255, 0.2);
        }

        .section-collapsible.expanded .section-toggle::before {
            transform: rotate(180deg);
            color: #00d9ff;
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding: 0 14px;
        }

        .section-collapsible.expanded .section-content {
            max-height: 500px;
            padding: 0 14px 14px 14px;
        }

        /* Employees */
        .add-employee {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .add-employee input {
            flex: 1;
            min-width: 0;
            padding: 10px;
            font-size: 14px;
        }

        .add-employee button {
            padding: 10px 14px;
            font-size: 1rem;
        }

        .employee-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 250px;
            overflow-y: auto;
        }

        .employee-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255,255,255,0.1);
            padding: 8px 10px;
            border-radius: 8px;
        }

        .employee-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .employee-info:hover {
            color: #00d9ff;
        }

        .employee-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .delete-btn {
            background: rgba(255, 71, 87, 0.3);
            color: #ff6b6b;
            padding: 6px 10px;
            font-size: 0.9rem;
            border-radius: 6px;
        }

        /* ==================== CALENDAR ==================== */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 8px;
        }

        .calendar-header h2 {
            font-size: 0.95rem;
            font-weight: 600;
            margin: 0;
            color: #fff;
        }

        .calendar-header button {
            padding: 8px 12px;
            font-size: 0.9rem;
            min-width: 40px;
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.6rem;
        }

        .legend-color {
            width: 18px;
            height: 14px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.5rem;
            font-weight: bold;
        }

        /* Table */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -10px;
            padding: 0 10px;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            min-width: max-content;
        }

        .schedule-table th,
        .schedule-table td {
            padding: 6px 3px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.12);
        }

        .schedule-table th {
            background: rgba(0, 217, 255, 0.2);
            font-size: 0.65rem;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .schedule-table th:first-child {
            position: sticky;
            left: 0;
            z-index: 20;
            background: rgba(0, 150, 200, 0.95);
        }

        .schedule-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 5;
            background: rgba(26, 26, 46, 0.98);
        }

        .schedule-table th.weekend {
            background: rgba(255, 71, 87, 0.25);
        }

        .schedule-table td.weekend {
            background: rgba(255, 71, 87, 0.08);
        }

        .schedule-table td.employee-name {
            text-align: left;
            font-size: 0.55rem;
            font-weight: 500;
            width: 65px;
            min-width: 65px;
            max-width: 65px;
            padding: 3px 5px;
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.15;
            vertical-align: middle;
            height: 34px;
            overflow: hidden;
            cursor: pointer;
            transition: background 0.2s;
        }

        .schedule-table td.employee-name:hover {
            background: rgba(0, 217, 255, 0.2);
        }

        .schedule-table td.employee-name:active {
            background: rgba(0, 217, 255, 0.3);
        }

        .shift-cell {
            cursor: pointer;
            min-width: 32px;
            height: 32px;
            font-size: 0.55rem;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        .shift-cell:active {
            opacity: 0.7;
        }

        .shift-work { 
            background: linear-gradient(135deg, #00d9ff, #00a8cc) !important; 
            color: #1a1a2e; 
        }
        .shift-work-cleaning { 
            background: linear-gradient(135deg, #a29bfe, #6c5ce7) !important; 
            color: #fff; 
        }
        .shift-work-fullCleaning { 
            background: linear-gradient(135deg, #fd79a8, #e84393) !important; 
            color: #fff; 
        }
        .shift-off { 
            background: linear-gradient(135deg, #636e72, #2d3436) !important; 
            color: #fff; 
        }
        .shift-vacation { 
            background: linear-gradient(135deg, #00ff88, #00b894) !important; 
            color: #1a1a2e; 
        }
        .shift-sick { 
            background: linear-gradient(135deg, #ff4757, #c0392b) !important; 
            color: #fff; 
        }

        .today { 
            box-shadow: inset 0 0 0 2px #00ff88; 
        }

        .total-cell {
            font-size: 0.75rem;
            font-weight: bold;
            background: rgba(0, 217, 255, 0.1);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 10px 6px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 0.6rem;
            color: #aaa;
            margin-bottom: 4px;
        }

        .stat-card .value {
            font-size: 1.2rem;
            font-weight: bold;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
        }

        .stats-table th,
        .stats-table td {
            padding: 8px 4px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stats-table th {
            background: rgba(0, 217, 255, 0.1);
            font-size: 0.65rem;
            font-weight: 600;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: flex-end;
            z-index: 1000;
        }

        .modal.active { 
            display: flex; 
        }

        .modal-content {
            background: #1a1a2e;
            padding: 18px 14px;
            padding-bottom: calc(18px + env(safe-area-inset-bottom));
            border-radius: 18px 18px 0 0;
            width: 100%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-content h3 {
            text-align: center;
            margin-bottom: 6px;
            font-size: 1rem;
        }

        .modal-info {
            text-align: center;
            color: #00d9ff;
            margin-bottom: 14px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .work-shift-form {
            background: rgba(255,255,255,0.05);
            padding: 14px;
            border-radius: 12px;
            margin-bottom: 14px;
        }

        .modal-section-title {
            text-align: center;
            color: #aaa;
            margin-bottom: 10px;
            font-size: 0.8rem;
        }

        .hours-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }

        .hours-row input {
            width: 80px;
            text-align: center;
            font-size: 1.4rem;
            padding: 10px;
            font-weight: bold;
        }

        .hours-row span {
            color: #aaa;
            font-size: 0.9rem;
        }

        .cleaning-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 14px;
        }

        .cleaning-option {
            padding: 10px 6px;
            border-radius: 10px;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            font-size: 0.75rem;
            text-align: center;
            transition: all 0.2s;
        }

        .cleaning-option:active {
            transform: scale(0.95);
        }

        .cleaning-option.active {
            border-color: #00d9ff;
            background: rgba(0, 217, 255, 0.2);
        }

        .cleaning-option.cleaning.active {
            border-color: #6c5ce7;
            background: rgba(162, 155, 254, 0.3);
        }

        .cleaning-option.fullCleaning.active {
            border-color: #e84393;
            background: rgba(253, 121, 168, 0.3);
        }

        .save-work-btn {
            width: 100%;
            padding: 12px;
            font-size: 0.9rem;
        }

        .divider {
            text-align: center;
            color: #555;
            margin: 14px 0;
            font-size: 0.75rem;
        }

        .other-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .other-option {
            padding: 12px 6px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-size: 0.7rem;
            transition: transform 0.2s;
        }

        .other-option:active {
            transform: scale(0.95);
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 14px;
        }

        .modal-buttons button {
            padding: 12px;
            font-size: 0.85rem;
        }

        /* ==================== EMPLOYEE CALENDAR MODAL ==================== */
        .employee-modal .modal-content {
            max-width: 360px;
            max-height: 90vh;
        }

        .employee-modal-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .employee-modal-header .emp-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        .employee-modal-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .employee-month-title {
            text-align: center;
            color: #00d9ff;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .employee-stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }

        .emp-stat {
            background: rgba(255,255,255,0.1);
            padding: 8px 4px;
            border-radius: 8px;
            text-align: center;
        }

        .emp-stat-label {
            font-size: 0.55rem;
            color: #888;
            margin-bottom: 2px;
        }

        .emp-stat-value {
            font-size: 1rem;
            font-weight: bold;
            color: #00d9ff;
        }

        .emp-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-bottom: 12px;
        }

        .emp-calendar-header {
            font-size: 0.6rem;
            color: #888;
            text-align: center;
            padding: 4px 0;
            font-weight: 600;
        }

        .emp-calendar-header.weekend {
            color: #ff6b6b;
        }

        .emp-calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.6rem;
            background: rgba(255,255,255,0.05);
            cursor: pointer;
            transition: transform 0.15s;
            position: relative;
        }

        .emp-calendar-day:active {
            transform: scale(0.9);
        }

        .emp-calendar-day.empty {
            background: transparent;
            cursor: default;
        }

        .emp-calendar-day .day-num {
            font-weight: 600;
            font-size: 0.65rem;
            line-height: 1;
        }

        .emp-calendar-day .day-shift {
            font-size: 0.5rem;
            font-weight: bold;
            margin-top: 1px;
        }

        .emp-calendar-day.shift-work { 
            background: linear-gradient(135deg, #00d9ff, #00a8cc); 
            color: #1a1a2e; 
        }
        .emp-calendar-day.shift-work-cleaning { 
            background: linear-gradient(135deg, #a29bfe, #6c5ce7); 
            color: #fff; 
        }
        .emp-calendar-day.shift-work-fullCleaning { 
            background: linear-gradient(135deg, #fd79a8, #e84393); 
            color: #fff; 
        }
        .emp-calendar-day.shift-off { 
            background: linear-gradient(135deg, #636e72, #2d3436); 
            color: #fff; 
        }
        .emp-calendar-day.shift-vacation { 
            background: linear-gradient(135deg, #00ff88, #00b894); 
            color: #1a1a2e; 
        }
        .emp-calendar-day.shift-sick { 
            background: linear-gradient(135deg, #ff4757, #c0392b); 
            color: #fff; 
        }

        .emp-calendar-day.today {
            box-shadow: inset 0 0 0 2px #fff;
        }

        .emp-calendar-day.weekend {
            border: 1px solid rgba(255, 71, 87, 0.3);
        }

        .emp-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .emp-legend-item {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 0.55rem;
            color: #aaa;
        }

        .emp-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .close-emp-modal {
            width: 100%;
            padding: 12px;
            font-size: 0.9rem;
        }

        /* Mobile tabs */
        .mobile-tabs {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.98);
            padding: 6px 0;
            padding-bottom: calc(6px + env(safe-area-inset-bottom));
            z-index: 100;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .mobile-tabs-inner {
            display: flex;
            justify-content: space-around;
        }

        .mobile-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px 12px;
            color: #666;
            font-size: 0.6rem;
            cursor: pointer;
            border: none;
            background: none;
            transition: color 0.2s;
        }

        .mobile-tab.active { 
            color: #00d9ff; 
        }
        
        .mobile-tab-icon { 
            font-size: 1.2rem; 
            margin-bottom: 2px; 
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 75px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, #2ed573, #1e90ff);
            color: #fff;
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.8rem;
            transition: transform 0.3s;
            z-index: 2000;
            white-space: nowrap;
        }

        .toast.show { 
            transform: translateX(-50%) translateY(0); 
        }
        .toast.error { 
            background: linear-gradient(135deg, #ff4757, #c0392b); 
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #00d9ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .mobile-tabs { 
                display: block; 
            }
            
            .section.hidden-mobile,
            .section-collapsible.hidden-mobile { 
                display: none; 
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .other-options {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .cleaning-options {
                grid-template-columns: 1fr;
                gap: 5px;
            }
        }

        @media (min-width: 769px) {
            body {
                font-size: 16px;
            }

            .app-screen { 
                padding: 25px; 
                padding-bottom: 30px;
                max-width: 1400px;
                margin: 0 auto;
            }

            .section {
                padding: 20px;
            }

            .section h2 {
                font-size: 1.1rem;
            }

            .section-collapsible .section-header h2 {
                font-size: 1.1rem;
            }

            .section-collapsible .section-content {
                padding: 0 20px;
            }

            .section-collapsible.expanded .section-content {
                padding: 0 20px 20px 20px;
            }

            .app-header h1 {
                font-size: 1.5rem;
            }

            .user-badge {
                font-size: 0.9rem;
                padding: 8px 14px;
            }

            .logout-btn {
                font-size: 0.85rem;
                padding: 8px 14px;
            }

            .control-group {
                padding: 10px 14px;
            }

            .control-group label {
                font-size: 0.85rem;
            }

            .btn-excel {
                font-size: 0.9rem;
                padding: 10px 18px;
            }

            .modal { 
                align-items: center; 
            }
            
            .modal-content { 
                border-radius: 20px; 
                max-height: 90vh;
                padding: 25px 20px;
                max-width: 450px;
            }

            .employee-modal .modal-content {
                max-width: 420px;
            }

            .modal-content h3 {
                font-size: 1.2rem;
            }

            .modal-info {
                font-size: 1rem;
            }

            .hours-row input {
                font-size: 1.8rem;
                width: 100px;
                padding: 14px;
            }

            .cleaning-options {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .cleaning-option {
                padding: 14px 10px;
                font-size: 0.9rem;
            }

            .other-options {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .other-option {
                padding: 16px 10px;
                font-size: 0.85rem;
            }

            .stats-grid {
                grid-template-columns: repeat(6, 1fr);
            }

            .stat-card {
                padding: 16px 10px;
            }

            .stat-card h3 {
                font-size: 0.8rem;
            }

            .stat-card .value {
                font-size: 1.6rem;
            }

            .shift-cell {
                min-width: 42px;
                height: 42px;
                font-size: 0.75rem;
            }

            .schedule-table th {
                font-size: 0.8rem;
                padding: 10px 5px;
            }

            .schedule-table td.employee-name {
                font-size: 0.7rem;
                width: 90px;
                min-width: 90px;
                max-width: 90px;
                padding: 5px 8px;
                height: 42px;
            }

            .employee-info {
                font-size: 0.95rem;
            }

            .employee-item {
                padding: 12px 14px;
            }

            .add-employee input {
                padding: 12px 14px;
            }

            .legend-item {
                font-size: 0.8rem;
            }

            .legend-color {
                width: 24px;
                height: 18px;
                font-size: 0.6rem;
            }

            .calendar-header h2 {
                font-size: 1.3rem;
            }

            .calendar-header button {
                padding: 10px 18px;
                font-size: 1.1rem;
            }

            .stats-table {
                font-size: 0.9rem;
            }

            .stats-table th {
                font-size: 0.85rem;
            }

            .emp-calendar-day {
                font-size: 0.75rem;
            }

            .emp-calendar-day .day-num {
                font-size: 0.8rem;
            }

            .emp-calendar-day .day-shift {
                font-size: 0.6rem;
            }

            .emp-calendar-header {
                font-size: 0.75rem;
            }

            .emp-stat-label {
                font-size: 0.65rem;
            }

            .emp-stat-value {
                font-size: 1.2rem;
            }

            .emp-legend-item {
                font-size: 0.7rem;
            }

            .emp-legend-color {
                width: 16px;
                height: 16px;
            }

            .section-header {
                padding: 14px 20px;
            }

            .section-header .employee-count {
                font-size: 0.8rem;
                padding: 3px 10px;
            }

            .section-toggle {
                width: 32px;
                height: 32px;
            }

            .section-toggle::before {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>üìÖ –ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω</h1>
            <p>–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è</p>
            <div class="login-error" id="loginError"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>–õ–æ–≥–∏–Ω</label>
                    <input type="text" id="loginUsername" placeholder="admin" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn">–í–æ–π—Ç–∏</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-screen" id="appScreen">
        <header class="app-header">
            <h1>üìÖ –ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω</h1>
            <div class="user-info">
                <span class="user-badge" id="userBadge">–ê–¥–º–∏–Ω</span>
                <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </header>

        <div class="controls">
            <div class="control-group">
                <label>–ú–µ—Å—è—Ü</label>
                <input type="month" id="monthPicker">
            </div>
            <button onclick="exportToExcel()" class="btn-excel">üìä Excel</button>
        </div>

        <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
        <section class="section" id="sectionCalendar">
            <div class="calendar-header">
                <button onclick="changeMonth(-1)">‚óÄ</button>
                <h2 id="currentMonthDisplay"></h2>
                <button onclick="changeMonth(1)">‚ñ∂</button>
            </div>

            <div class="legend">
                <div class="legend-item"><div class="legend-color shift-work">10</div><span>–ß–∞—Å—ã</span></div>
                <div class="legend-item"><div class="legend-color shift-work-cleaning">–£</div><span>–£–±–æ—Ä–∫–∞</span></div>
                <div class="legend-item"><div class="legend-color shift-work-fullCleaning">–£1</div><span>–ü–æ–ª–Ω–∞—è</span></div>
                <div class="legend-item"><div class="legend-color shift-off">–í</div><span>–í—ã—Ö</span></div>
                <div class="legend-item"><div class="legend-color shift-vacation">–û</div><span>–û—Ç–ø</span></div>
                <div class="legend-item"><div class="legend-color shift-sick">–ë</div><span>–ë–æ–ª</span></div>
            </div>

            <div class="table-wrapper">
                <table class="schedule-table">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ - —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–π –±–ª–æ–∫ -->
        <section class="section-collapsible" id="sectionEmployees">
            <div class="section-header" onclick="toggleEmployeesSection()">
                <h2>
                    üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
                    <span class="employee-count" id="employeeCount">0</span>
                </h2>
                <div class="section-toggle"></div>
            </div>
            <div class="section-content">
                <div class="add-employee">
                    <input type="text" id="newEmployeeName" placeholder="–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞">
                    <button onclick="addEmployee()">+</button>
                </div>
                <div class="employee-list" id="employeeList">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </section>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <section class="section" id="sectionStats">
            <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div class="stats-grid" id="statsGrid"></div>
            <div class="table-wrapper">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                            <th>–°–º–µ–Ω</th>
                            <th>–ß–∞—Å–æ–≤</th>
                            <th>–£</th>
                            <th>–£1</th>
                            <th>–í</th>
                            <th>–û</th>
                            <th>–ë</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody"></tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Mobile Tabs -->
    <nav class="mobile-tabs" id="mobileTabs">
        <div class="mobile-tabs-inner">
            <button class="mobile-tab active" onclick="showSection('calendar')">
                <span class="mobile-tab-icon">üìÖ</span>
                <span>–ì—Ä–∞—Ñ–∏–∫</span>
            </button>
            <button class="mobile-tab" onclick="showSection('employees')">
                <span class="mobile-tab-icon">üë•</span>
                <span>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
            </button>
            <button class="mobile-tab" onclick="showSection('stats')">
                <span class="mobile-tab-icon">üìä</span>
                <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
            </button>
        </div>
    </nav>

    <!-- Shift Edit Modal -->
    <div class="modal" id="shiftModal">
        <div class="modal-content">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <div class="modal-info" id="modalInfo"></div>
            
            <div class="work-shift-form">
                <div class="modal-section-title">‚è∞ –†–∞–±–æ—á–∞—è —Å–º–µ–Ω–∞</div>
                <div class="hours-row">
                    <input type="number" id="modalHours" min="1" max="24" value="10" inputmode="numeric">
                    <span>—á–∞—Å–æ–≤</span>
                </div>
                <div class="cleaning-options">
                    <div class="cleaning-option none active" onclick="selectCleaning('none')">–ë–µ–∑ —É–±–æ—Ä–∫–∏</div>
                    <div class="cleaning-option cleaning" onclick="selectCleaning('cleaning')">üßπ –£–±–æ—Ä–∫–∞</div>
                    <div class="cleaning-option fullCleaning" onclick="selectCleaning('fullCleaning')">üßΩ –ü–æ–ª–Ω–∞—è</div>
                </div>
                <button class="save-work-btn" onclick="saveWorkShift()">‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>

            <div class="divider">‚Äî –∏–ª–∏ –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ ‚Äî</div>

            <div class="other-options">
                <div class="other-option shift-off" onclick="setDayType('off')">üè† –í—ã—Ö–æ–¥–Ω–æ–π</div>
                <div class="other-option shift-vacation" onclick="setDayType('vacation')">üèñÔ∏è –û—Ç–ø—É—Å–∫</div>
                <div class="other-option shift-sick" onclick="setDayType('sick')">üè• –ë–æ–ª—å–Ω–∏—á–Ω—ã–π</div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-danger" onclick="clearShift()">‚úñ –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- Employee Calendar Modal -->
    <div class="modal employee-modal" id="employeeModal">
        <div class="modal-content">
            <div class="employee-modal-header">
                <div class="emp-color" id="empModalColor"></div>
                <h3 id="empModalName"></h3>
            </div>
            
            <div class="employee-month-title" id="empModalMonth"></div>
            
            <div class="employee-stats-row" id="empModalStats"></div>
            
            <div class="emp-calendar" id="empModalCalendar"></div>
            
            <div class="emp-legend">
                <div class="emp-legend-item"><div class="emp-legend-color shift-work"></div>–†–∞–±–æ—Ç–∞</div>
                <div class="emp-legend-item"><div class="emp-legend-color shift-work-cleaning"></div>–£–±–æ—Ä–∫–∞</div>
                <div class="emp-legend-item"><div class="emp-legend-color shift-work-fullCleaning"></div>–ü–æ–ª–Ω–∞—è</div>
                <div class="emp-legend-item"><div class="emp-legend-color shift-off"></div>–í—ã—Ö</div>
                <div class="emp-legend-item"><div class="emp-legend-color shift-vacation"></div>–û—Ç–ø</div>
                <div class="emp-legend-item"><div class="emp-legend-color shift-sick"></div>–ë–æ–ª</div>
            </div>
            
            <button class="close-emp-modal btn-secondary" onclick="closeEmployeeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API_URL = '';
        const DEFAULT_HOURS = 10;
        
        let currentUser = null;
        let token = null;
        let employees = [];
        let shifts = {};
        let currentDate = new Date();
        let selectedCell = null;
        let selectedCleaning = 'none';
        let selectedEmployee = null;
        let isMobile = window.innerWidth <= 768;

        const monthNames = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
        const monthNamesShort = ['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];
        const dayNames = ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            initMonthPicker();
            window.addEventListener('resize', handleResize);
            handleResize();
        });

        function handleResize() {
            isMobile = window.innerWidth <= 768;
            if (!isMobile) {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('hidden-mobile'));
                document.querySelectorAll('.section-collapsible').forEach(s => s.classList.remove('hidden-mobile'));
            }
        }

        // ==================== COLLAPSIBLE SECTION ====================
        function toggleEmployeesSection() {
            const section = document.getElementById('sectionEmployees');
            section.classList.toggle('expanded');
        }

        async function checkAuth() {
            token = localStorage.getItem('token');
            if (!token) { showLogin(); return; }
            try {
                const res = await api('/api/auth/verify');
                currentUser = res.user;
                showApp();
            } catch (e) {
                localStorage.removeItem('token');
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.remove('active');
            document.getElementById('mobileTabs').style.display = 'none';
        }

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.add('active');

            if (isMobile) {
                document.getElementById('mobileTabs').style.display = 'block';
                showSection('calendar');
            }

            document.getElementById('userBadge').textContent = currentUser.name;
            loadData();
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            try {
                const res = await fetch(API_URL + '/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (!res.ok) {
                    errorDiv.textContent = data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
                    errorDiv.style.display = 'block';
                    return;
                }
                token = data.token;
                currentUser = data.user;
                localStorage.setItem('token', token);
                errorDiv.style.display = 'none';
                showApp();
            } catch (e) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                errorDiv.style.display = 'block';
            }
        });

        function logout() {
            localStorage.removeItem('token');
            token = null;
            currentUser = null;
            showLogin();
        }

        async function api(endpoint, options = {}) {
            const res = await fetch(API_URL + endpoint, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞');
            return data;
        }

        async function loadData() {
            try {
                [employees, shifts] = await Promise.all([
                    api('/api/employees'),
                    api('/api/shifts')
                ]);
                render();
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞: ' + e.message, true);
            }
        }

        async function addEmployee() {
            const input = document.getElementById('newEmployeeName');
            const name = input.value.trim();
            if (!name) return;
            try {
                const emp = await api('/api/employees', { method: 'POST', body: JSON.stringify({ name }) });
                employees.push(emp);
                input.value = '';
                render();
                showToast('‚úì ' + name);
            } catch (e) {
                showToast(e.message, true);
            }
        }

        async function deleteEmployee(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?')) return;
            try {
                await api('/api/employees/' + id, { method: 'DELETE' });
                employees = employees.filter(e => e.id !== id);
                Object.keys(shifts).filter(k => k.startsWith(id + '_')).forEach(k => delete shifts[k]);
                render();
                showToast('–£–¥–∞–ª–µ–Ω–æ');
            } catch (e) {
                showToast(e.message, true);
            }
        }

        document.getElementById('newEmployeeName').addEventListener('keypress', e => {
            if (e.key === 'Enter') addEmployee();
        });

        async function saveShift(key, data) {
            try {
                await api('/api/shifts', { method: 'POST', body: JSON.stringify({ key, data }) });
                if (data === null) delete shifts[key];
                else shifts[key] = data;
                render();
                if (selectedEmployee) {
                    renderEmployeeCalendar(selectedEmployee);
                }
            } catch (e) {
                showToast(e.message, true);
            }
        }

        async function saveWorkShift() {
            if (!selectedCell) return;
            const hours = parseInt(document.getElementById('modalHours').value) || DEFAULT_HOURS;
            const key = `${selectedCell.empId}_${selectedCell.year}-${selectedCell.month}-${selectedCell.day}`;
            await saveShift(key, { type: 'work', hours, cleaning: selectedCleaning === 'none' ? null : selectedCleaning });
            closeModal();
        }

        async function setDayType(type) {
            if (!selectedCell) return;
            const key = `${selectedCell.empId}_${selectedCell.year}-${selectedCell.month}-${selectedCell.day}`;
            await saveShift(key, { type });
            closeModal();
        }

        async function clearShift() {
            if (!selectedCell) return;
            const key = `${selectedCell.empId}_${selectedCell.year}-${selectedCell.month}-${selectedCell.day}`;
            await saveShift(key, null);
            closeModal();
        }

        function render() {
            renderEmployeeList();
            renderCalendar();
            renderStats();
            // –û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            document.getElementById('employeeCount').textContent = employees.length;
        }

        function renderEmployeeList() {
            const list = document.getElementById('employeeList');
            if (!employees.length) {
                list.innerHTML = '<p style="color:#888;text-align:center;padding:15px;font-size:0.8rem">–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>';
                return;
            }
            list.innerHTML = employees.map(e => `
                <div class="employee-item">
                    <div class="employee-info" onclick="openEmployeeModal('${e.id}')">
                        <div class="employee-color" style="background:${e.color}"></div>
                        <span>${e.name}</span>
                    </div>
                    <button class="delete-btn" onclick="deleteEmployee('${e.id}')">√ó</button>
                </div>
            `).join('');
        }

        function initMonthPicker() {
            const picker = document.getElementById('monthPicker');
            picker.value = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            picker.addEventListener('change', function() {
                const [y, m] = this.value.split('-');
                currentDate = new Date(y, m - 1, 1);
                render();
            });
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            document.getElementById('monthPicker').value = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            render();
        }

        function getDaysInMonth(y, m) { return new Date(y, m + 1, 0).getDate(); }
        function getDayOfWeek(y, m, d) { return new Date(y, m, d).getDay(); }
        function getFirstDayOfMonth(y, m) { return new Date(y, m, 1).getDay(); }

        function getShiftDisplay(data) {
            if (!data) return { label: '', class: '' };
            if (data.type === 'work') {
                let label = data.hours.toString();
                let cls = 'shift-work';
                if (data.cleaning === 'cleaning') { label += '/–£'; cls = 'shift-work-cleaning'; }
                else if (data.cleaning === 'fullCleaning') { label += '/–£1'; cls = 'shift-work-fullCleaning'; }
                return { label, class: cls };
            }
            const map = {
                'off': { label: '–í', class: 'shift-off' },
                'vacation': { label: '–û', class: 'shift-vacation' },
                'sick': { label: '–ë', class: 'shift-sick' }
            };
            return map[data.type] || { label: '', class: '' };
        }

        function getShiftShortDisplay(data) {
            if (!data) return { label: '', class: '' };
            if (data.type === 'work') {
                let label = data.hours.toString();
                let cls = 'shift-work';
                if (data.cleaning === 'cleaning') { cls = 'shift-work-cleaning'; }
                else if (data.cleaning === 'fullCleaning') { cls = 'shift-work-fullCleaning'; }
                return { label, class: cls };
            }
            const map = {
                'off': { label: '–í', class: 'shift-off' },
                'vacation': { label: '–û', class: 'shift-vacation' },
                'sick': { label: '–ë', class: 'shift-sick' }
            };
            return map[data.type] || { label: '', class: '' };
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const days = getDaysInMonth(year, month);
            const today = new Date();

            document.getElementById('currentMonthDisplay').textContent = `${monthNames[month]} ${year}`;

            let head = '<tr><th>–ò–º—è</th>';
            for (let d = 1; d <= days; d++) {
                const dow = getDayOfWeek(year, month, d);
                const isWeekend = dow === 0 || dow === 6;
                const isToday = today.getDate() === d && today.getMonth() === month && today.getFullYear() === year;
                head += `<th class="${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}">${d}<br><small>${dayNames[dow]}</small></th>`;
            }
            head += '<th>Œ£</th></tr>';
            document.getElementById('tableHead').innerHTML = head;

            if (!employees.length) {
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="${days + 2}" style="text-align:center;padding:20px;color:#888;font-size:0.8rem">–î–æ–±–∞–≤—å—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</td></tr>`;
                return;
            }

            let body = '';
            employees.forEach(emp => {
                body += `<tr><td class="employee-name" onclick="openEmployeeModal('${emp.id}')"><span style="color:${emp.color}">‚óè</span> ${emp.name}</td>`;
                let total = 0;
                for (let d = 1; d <= days; d++) {
                    const dow = getDayOfWeek(year, month, d);
                    const isWeekend = dow === 0 || dow === 6;
                    const isToday = today.getDate() === d && today.getMonth() === month && today.getFullYear() === year;
                    const key = `${emp.id}_${year}-${month}-${d}`;
                    const shift = shifts[key];
                    const disp = getShiftDisplay(shift);
                    if (shift?.type === 'work') total += shift.hours;
                    body += `<td class="shift-cell ${disp.class} ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}" 
                        onclick="openShiftModal('${emp.id}',${year},${month},${d})">${disp.label}</td>`;
                }
                body += `<td class="total-cell">${total}</td></tr>`;
            });
            document.getElementById('tableBody').innerHTML = body;
        }

        function renderStats() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const days = getDaysInMonth(year, month);
            
            let totals = { hours: 0, shifts: 0, cleaning: 0, fullCleaning: 0 };
            let rows = '';
            
            employees.forEach(emp => {
                let s = { hours: 0, shifts: 0, cleaning: 0, fullCleaning: 0, off: 0, vacation: 0, sick: 0 };
                for (let d = 1; d <= days; d++) {
                    const shift = shifts[`${emp.id}_${year}-${month}-${d}`];
                    if (shift) {
                        if (shift.type === 'work') {
                            s.hours += shift.hours;
                            s.shifts++;
                            if (shift.cleaning === 'cleaning') s.cleaning++;
                            else if (shift.cleaning === 'fullCleaning') s.fullCleaning++;
                        } else s[shift.type]++;
                    }
                }
                totals.hours += s.hours;
                totals.shifts += s.shifts;
                totals.cleaning += s.cleaning;
                totals.fullCleaning += s.fullCleaning;
                
                rows += `<tr>
                    <td><span style="color:${emp.color}">‚óè</span> ${emp.name}</td>
                    <td><strong>${s.shifts}</strong></td>
                    <td><strong>${s.hours}</strong></td>
                    <td>${s.cleaning || '-'}</td>
                    <td>${s.fullCleaning || '-'}</td>
                    <td>${s.off || '-'}</td>
                    <td>${s.vacation || '-'}</td>
                    <td>${s.sick || '-'}</td>
                </tr>`;
            });
            
            document.getElementById('statsTableBody').innerHTML = rows;
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card"><h3>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h3><div class="value">${employees.length}</div></div>
                <div class="stat-card"><h3>–°–º–µ–Ω</h3><div class="value">${totals.shifts}</div></div>
                <div class="stat-card"><h3>–ß–∞—Å–æ–≤</h3><div class="value">${totals.hours}</div></div>
                <div class="stat-card"><h3>–£–±–æ—Ä–æ–∫</h3><div class="value">${totals.cleaning}</div></div>
                <div class="stat-card"><h3>–ü–æ–ª–Ω—ã—Ö</h3><div class="value">${totals.fullCleaning}</div></div>
                <div class="stat-card"><h3>–°—Ä. —á–∞—Å–æ–≤</h3><div class="value">${employees.length ? Math.round(totals.hours / employees.length) : 0}</div></div>
            `;
        }

        function selectCleaning(type) {
            selectedCleaning = type;
            document.querySelectorAll('.cleaning-option').forEach(el => el.classList.remove('active'));
            document.querySelector(`.cleaning-option.${type === 'none' ? 'none' : type}`).classList.add('active');
        }

        function openShiftModal(empId, year, month, day) {
            selectedCell = { empId, year, month, day };
            const emp = employees.find(e => e.id === empId);
            document.getElementById('modalInfo').textContent = `${emp.name} ‚Äî ${day} ${monthNamesShort[month]} ${year}`;
            
            const key = `${empId}_${year}-${month}-${day}`;
            const shift = shifts[key];
            
            if (shift?.type === 'work') {
                document.getElementById('modalHours').value = shift.hours;
                selectCleaning(shift.cleaning || 'none');
            } else {
                document.getElementById('modalHours').value = DEFAULT_HOURS;
                selectCleaning('none');
            }
            
            document.getElementById('shiftModal').classList.add('active');
            setTimeout(() => document.getElementById('modalHours').select(), 150);
        }

        function closeModal() {
            document.getElementById('shiftModal').classList.remove('active');
            selectedCell = null;
        }

        // ==================== EMPLOYEE CALENDAR MODAL ====================
        function openEmployeeModal(empId) {
            const emp = employees.find(e => e.id === empId);
            if (!emp) return;
            
            selectedEmployee = empId;
            
            document.getElementById('empModalColor').style.background = emp.color;
            document.getElementById('empModalName').textContent = emp.name;
            
            renderEmployeeCalendar(empId);
            
            document.getElementById('employeeModal').classList.add('active');
        }

        function renderEmployeeCalendar(empId) {
            const emp = employees.find(e => e.id === empId);
            if (!emp) return;
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const days = getDaysInMonth(year, month);
            const firstDay = getFirstDayOfMonth(year, month);
            const today = new Date();
            
            document.getElementById('empModalMonth').textContent = `${monthNames[month]} ${year}`;
            
            let stats = { hours: 0, shifts: 0, cleaning: 0, fullCleaning: 0 };
            for (let d = 1; d <= days; d++) {
                const shift = shifts[`${empId}_${year}-${month}-${d}`];
                if (shift?.type === 'work') {
                    stats.hours += shift.hours;
                    stats.shifts++;
                    if (shift.cleaning === 'cleaning') stats.cleaning++;
                    else if (shift.cleaning === 'fullCleaning') stats.fullCleaning++;
                }
            }
            
            document.getElementById('empModalStats').innerHTML = `
                <div class="emp-stat">
                    <div class="emp-stat-label">–°–º–µ–Ω</div>
                    <div class="emp-stat-value">${stats.shifts}</div>
                </div>
                <div class="emp-stat">
                    <div class="emp-stat-label">–ß–∞—Å–æ–≤</div>
                    <div class="emp-stat-value">${stats.hours}</div>
                </div>
                <div class="emp-stat">
                    <div class="emp-stat-label">–£–±–æ—Ä–æ–∫</div>
                    <div class="emp-stat-value">${stats.cleaning}</div>
                </div>
                <div class="emp-stat">
                    <div class="emp-stat-label">–ü–æ–ª–Ω—ã—Ö</div>
                    <div class="emp-stat-value">${stats.fullCleaning}</div>
                </div>
            `;
            
            let calendarHtml = '';
            
            const daysOrder = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            daysOrder.forEach((day, i) => {
                const isWeekend = i >= 5;
                calendarHtml += `<div class="emp-calendar-header ${isWeekend ? 'weekend' : ''}">${day}</div>`;
            });
            
            const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
            for (let i = 0; i < adjustedFirstDay; i++) {
                calendarHtml += '<div class="emp-calendar-day empty"></div>';
            }
            
            for (let d = 1; d <= days; d++) {
                const dow = getDayOfWeek(year, month, d);
                const isWeekend = dow === 0 || dow === 6;
                const isToday = today.getDate() === d && today.getMonth() === month && today.getFullYear() === year;
                
                const key = `${empId}_${year}-${month}-${d}`;
                const shift = shifts[key];
                const disp = getShiftShortDisplay(shift);
                
                calendarHtml += `
                    <div class="emp-calendar-day ${disp.class} ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}"
                         onclick="openShiftFromEmpModal('${empId}', ${year}, ${month}, ${d})">
                        <span class="day-num">${d}</span>
                        <span class="day-shift">${disp.label}</span>
                    </div>
                `;
            }
            
            document.getElementById('empModalCalendar').innerHTML = calendarHtml;
        }

        function openShiftFromEmpModal(empId, year, month, day) {
            closeEmployeeModal();
            setTimeout(() => {
                openShiftModal(empId, year, month, day);
            }, 150);
        }

        function closeEmployeeModal() {
            document.getElementById('employeeModal').classList.remove('active');
            selectedEmployee = null;
        }

        document.getElementById('shiftModal').addEventListener('click', e => {
            if (e.target.id === 'shiftModal') closeModal();
        });

        document.getElementById('employeeModal').addEventListener('click', e => {
            if (e.target.id === 'employeeModal') closeEmployeeModal();
        });

        document.getElementById('modalHours').addEventListener('keypress', e => {
            if (e.key === 'Enter') { e.preventDefault(); saveWorkShift(); }
        });

        function showSection(section) {
            if (!isMobile) return;
            document.querySelectorAll('.mobile-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden-mobile'));
            document.querySelectorAll('.section-collapsible').forEach(s => s.classList.add('hidden-mobile'));
            
            const map = { 
                calendar: 'sectionCalendar', 
                employees: 'sectionEmployees', 
                stats: 'sectionStats' 
            };
            
            const targetSection = document.getElementById(map[section]);
            targetSection.classList.remove('hidden-mobile');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
            if (section === 'employees') {
                targetSection.classList.add('expanded');
            }
            
            document.querySelector(`.mobile-tab[onclick="showSection('${section}')"]`).classList.add('active');
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        function exportToExcel() {
            try {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const days = getDaysInMonth(year, month);
                const wb = XLSX.utils.book_new();

                const data = [[`–ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω - ${monthNames[month]} ${year}`], []];
                const header = ['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'];
                for (let d = 1; d <= days; d++) header.push(`${d} ${dayNames[getDayOfWeek(year, month, d)]}`);
                header.push('–ß–∞—Å–æ–≤');
                data.push(header);

                employees.forEach(emp => {
                    const row = [emp.name];
                    let total = 0;
                    for (let d = 1; d <= days; d++) {
                        const shift = shifts[`${emp.id}_${year}-${month}-${d}`];
                        row.push(getShiftDisplay(shift).label);
                        if (shift?.type === 'work') total += shift.hours;
                    }
                    row.push(total);
                    data.push(row);
                });

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{ wch: 20 }, ...Array(days).fill({ wch: 6 }), { wch: 8 }];
                XLSX.utils.book_append_sheet(wb, ws, '–ì—Ä–∞—Ñ–∏–∫');
                
                const fileName = `–°–º–µ–Ω—ã_${monthNamesShort[month]}_${year}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast('üìä –§–∞–π–ª —Å–∫–∞—á–∞–Ω: ' + fileName);
            } catch (error) {
                showToast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message, true);
            }
        }

        document.addEventListener('keydown', e => { 
            if (e.key === 'Escape') {
                closeModal();
                closeEmployeeModal();
            }
        });
    </script>
</body>
</html>
