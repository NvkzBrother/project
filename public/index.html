<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00d9ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–°–º–µ–Ω—ã">
    <link rel="apple-touch-icon" href="/icon-192.png">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW error:', err));
            });
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            font-size: 16px;
        }

        /* ==================== LOGIN ==================== */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(255,255,255,0.1);
            padding: 40px 25px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .login-box p {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 1rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 1rem;
        }

        .form-group input {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 18px;
        }

        .form-group input:focus {
            outline: 2px solid #00d9ff;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            color: #1a1a2e;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
        }

        .login-error {
            background: rgba(255, 71, 87, 0.2);
            color: #ff6b6b;
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
            font-size: 1rem;
        }

        /* ==================== MAIN APP ==================== */
        .app-screen {
            display: none;
            padding: 15px;
            padding-bottom: 90px;
        }

        .app-screen.active {
            display: block;
        }

        .login-screen.hidden {
            display: none;
        }

        /* Header */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .app-header h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-badge {
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255, 71, 87, 0.2);
            color: #ff6b6b;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            background: rgba(255,255,255,0.1);
            padding: 12px 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-size: 0.9rem;
            color: #aaa;
            white-space: nowrap;
        }

        input, select, button {
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
        }

        input, select {
            background: rgba(255,255,255,0.15);
            color: #fff;
        }

        button {
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
            min-height: 48px;
        }

        .btn-excel {
            background: linear-gradient(135deg, #2ed573, #1e90ff);
            font-size: 1rem;
            padding: 12px 20px;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #576574, #8395a7);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #ff6b81);
        }

        /* Sections */
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .section h2 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #00d9ff;
        }

        /* Employees */
        .add-employee {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .add-employee input {
            flex: 1;
            min-width: 0;
            padding: 14px 16px;
            font-size: 16px;
        }

        .add-employee button {
            padding: 14px 20px;
            font-size: 1.3rem;
        }

        .employee-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 250px;
            overflow-y: auto;
        }

        .employee-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255,255,255,0.1);
            padding: 14px 16px;
            border-radius: 12px;
        }

        .employee-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1rem;
        }

        .employee-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .delete-btn {
            background: rgba(255, 71, 87, 0.3);
            color: #ff6b6b;
            padding: 10px 16px;
            font-size: 1.2rem;
            border-radius: 8px;
        }

        /* ==================== CALENDAR ==================== */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .calendar-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
            color: #fff;
        }

        .calendar-header button {
            padding: 12px 20px;
            font-size: 1.2rem;
            min-width: 50px;
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 24px;
            height: 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: bold;
        }

        /* Table */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -16px;
            padding: 0 16px;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            min-width: max-content;
        }

        .schedule-table th,
        .schedule-table td {
            padding: 10px 6px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .schedule-table th {
            background: rgba(0, 217, 255, 0.2);
            font-size: 0.85rem;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .schedule-table th:first-child {
            position: sticky;
            left: 0;
            z-index: 20;
            background: rgba(0, 150, 200, 0.95);
        }

        .schedule-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 5;
            background: rgba(26, 26, 46, 0.98);
        }

        .schedule-table th.weekend {
            background: rgba(255, 71, 87, 0.25);
        }

        .schedule-table td.weekend {
            background: rgba(255, 71, 87, 0.08);
        }

        .schedule-table td.employee-name {
            text-align: left;
            font-size: 0.9rem;
            font-weight: 500;
            min-width: 100px;
            max-width: 130px;
            padding: 10px 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .shift-cell {
            cursor: pointer;
            min-width: 44px;
            height: 44px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        .shift-cell:active {
            opacity: 0.7;
        }

        .shift-work { 
            background: linear-gradient(135deg, #00d9ff, #00a8cc) !important; 
            color: #1a1a2e; 
        }
        .shift-work-cleaning { 
            background: linear-gradient(135deg, #a29bfe, #6c5ce7) !important; 
            color: #fff; 
        }
        .shift-work-fullCleaning { 
            background: linear-gradient(135deg, #fd79a8, #e84393) !important; 
            color: #fff; 
        }
        .shift-off { 
            background: linear-gradient(135deg, #636e72, #2d3436) !important; 
            color: #fff; 
        }
        .shift-vacation { 
            background: linear-gradient(135deg, #00ff88, #00b894) !important; 
            color: #1a1a2e; 
        }
        .shift-sick { 
            background: linear-gradient(135deg, #ff4757, #c0392b) !important; 
            color: #fff; 
        }

        .today { 
            box-shadow: inset 0 0 0 3px #00ff88; 
        }

        .total-cell {
            font-size: 1rem;
            font-weight: bold;
            background: rgba(0, 217, 255, 0.1);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 16px 12px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 1.6rem;
            font-weight: bold;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .stats-table th,
        .stats-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stats-table th {
            background: rgba(0, 217, 255, 0.1);
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: flex-end;
            z-index: 1000;
        }

        .modal.active { 
            display: flex; 
        }

        .modal-content {
            background: #1a1a2e;
            padding: 25px 20px;
            padding-bottom: calc(25px + env(safe-area-inset-bottom));
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-content h3 {
            text-align: center;
            margin-bottom: 8px;
            font-size: 1.3rem;
        }

        .modal-info {
            text-align: center;
            color: #00d9ff;
            margin-bottom: 20px;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .work-shift-form {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .modal-section-title {
            text-align: center;
            color: #aaa;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .hours-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .hours-row input {
            width: 100px;
            text-align: center;
            font-size: 1.8rem;
            padding: 14px;
            font-weight: bold;
        }

        .hours-row span {
            color: #aaa;
            font-size: 1.1rem;
        }

        .cleaning-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .cleaning-option {
            padding: 16px 12px;
            border-radius: 12px;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
            border: 3px solid transparent;
            font-size: 1rem;
            text-align: center;
            transition: all 0.2s;
        }

        .cleaning-option:active {
            transform: scale(0.95);
        }

        .cleaning-option.active {
            border-color: #00d9ff;
            background: rgba(0, 217, 255, 0.2);
        }

        .cleaning-option.cleaning.active {
            border-color: #6c5ce7;
            background: rgba(162, 155, 254, 0.3);
        }

        .cleaning-option.fullCleaning.active {
            border-color: #e84393;
            background: rgba(253, 121, 168, 0.3);
        }

        .save-work-btn {
            width: 100%;
            padding: 18px;
            font-size: 1.1rem;
        }

        .divider {
            text-align: center;
            color: #555;
            margin: 20px 0;
            font-size: 0.95rem;
        }

        .other-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .other-option {
            padding: 18px 12px;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-size: 0.95rem;
            transition: transform 0.2s;
        }

        .other-option:active {
            transform: scale(0.95);
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-buttons button {
            padding: 16px;
            font-size: 1rem;
        }

        /* Mobile tabs */
        .mobile-tabs {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.98);
            padding: 10px 0;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            z-index: 100;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .mobile-tabs-inner {
            display: flex;
            justify-content: space-around;
        }

        .mobile-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 20px;
            color: #666;
            font-size: 0.8rem;
            cursor: pointer;
            border: none;
            background: none;
            transition: color 0.2s;
        }

        .mobile-tab.active { 
            color: #00d9ff; 
        }
        
        .mobile-tab-icon { 
            font-size: 1.6rem; 
            margin-bottom: 4px; 
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, #2ed573, #1e90ff);
            color: #fff;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
            transition: transform 0.3s;
            z-index: 2000;
            white-space: nowrap;
        }

        .toast.show { 
            transform: translateX(-50%) translateY(0); 
        }
        .toast.error { 
            background: linear-gradient(135deg, #ff4757, #c0392b); 
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #00d9ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .mobile-tabs { 
                display: block; 
            }
            
            .section.hidden-mobile { 
                display: none; 
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .other-options {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .cleaning-options {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        @media (min-width: 769px) {
            .app-screen { 
                padding: 25px; 
                padding-bottom: 30px;
                max-width: 1400px;
                margin: 0 auto;
            }

            .section {
                padding: 20px;
            }

            .modal { 
                align-items: center; 
            }
            
            .modal-content { 
                border-radius: 24px; 
                max-height: 90vh;
            }

            .stats-grid {
                grid-template-columns: repeat(6, 1fr);
            }

            .shift-cell {
                min-width: 48px;
                height: 48px;
                font-size: 0.85rem;
            }
        }

        @media (min-width: 1024px) {
            .main-grid {
                display: grid;
                grid-template-columns: 300px 1fr;
                gap: 20px;
            }
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>üìÖ –ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω</h1>
            <p>–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è</p>
            <div class="login-error" id="loginError"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>–õ–æ–≥–∏–Ω</label>
                    <input type="text" id="loginUsername" placeholder="admin" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn">–í–æ–π—Ç–∏</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-screen" id="appScreen">
        <header class="app-header">
            <h1>üìÖ –ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω</h1>
            <div class="user-info">
                <span class="user-badge" id="userBadge">–ê–¥–º–∏–Ω</span>
                <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </header>

        <div class="controls">
            <div class="control-group">
                <label>–ú–µ—Å—è—Ü</label>
                <input type="month" id="monthPicker">
            </div>
            <button onclick="exportToExcel()" class="btn-excel">üìä Excel</button>
        </div>

        <div class="main-grid">
            <!-- –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ -->
            <section class="section" id="sectionEmployees">
                <h2>üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2>
                <div class="add-employee">
                    <input type="text" id="newEmployeeName" placeholder="–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞">
                    <button onclick="addEmployee()">+</button>
                </div>
                <div class="employee-list" id="employeeList">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </section>

            <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
            <section class="section" id="sectionCalendar">
                <div class="calendar-header">
                    <button onclick="changeMonth(-1)">‚óÄ</button>
                    <h2 id="currentMonthDisplay"></h2>
                    <button onclick="changeMonth(1)">‚ñ∂</button>
                </div>

                <div class="legend">
                    <div class="legend-item"><div class="legend-color shift-work">10</div><span>–ß–∞—Å—ã</span></div>
                    <div class="legend-item"><div class="legend-color shift-work-cleaning">–£</div><span>–£–±–æ—Ä–∫–∞</span></div>
                    <div class="legend-item"><div class="legend-color shift-work-fullCleaning">–£1</div><span>–ü–æ–ª–Ω–∞—è</span></div>
                    <div class="legend-item"><div class="legend-color shift-off">–í</div><span>–í—ã—Ö–æ–¥–Ω–æ–π</span></div>
                    <div class="legend-item"><div class="legend-color shift-vacation">–û</div><span>–û—Ç–ø—É—Å–∫</span></div>
                    <div class="legend-item"><div class="legend-color shift-sick">–ë</div><span>–ë–æ–ª—å–Ω–∏—á–Ω—ã–π</span></div>
                </div>

                <div class="table-wrapper">
                    <table class="schedule-table">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <section class="section" id="sectionStats">
            <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div class="stats-grid" id="statsGrid"></div>
            <div class="table-wrapper">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                            <th>–°–º–µ–Ω</th>
                            <th>–ß–∞—Å–æ–≤</th>
                            <th>–£</th>
                            <th>–£1</th>
                            <th>–í</th>
                            <th>–û</th>
                            <th>–ë</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody"></tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Mobile Tabs -->
    <nav class="mobile-tabs" id="mobileTabs">
        <div class="mobile-tabs-inner">
            <button class="mobile-tab active" onclick="showSection('calendar')">
                <span class="mobile-tab-icon">üìÖ</span>
                <span>–ì—Ä–∞—Ñ–∏–∫</span>
            </button>
            <button class="mobile-tab" onclick="showSection('employees')">
                <span class="mobile-tab-icon">üë•</span>
                <span>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
            </button>
            <button class="mobile-tab" onclick="showSection('stats')">
                <span class="mobile-tab-icon">üìä</span>
                <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
            </button>
        </div>
    </nav>

    <!-- Modal -->
    <div class="modal" id="shiftModal">
        <div class="modal-content">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <div class="modal-info" id="modalInfo"></div>
            
            <div class="work-shift-form">
                <div class="modal-section-title">‚è∞ –†–∞–±–æ—á–∞—è —Å–º–µ–Ω–∞</div>
                <div class="hours-row">
                    <input type="number" id="modalHours" min="1" max="24" value="10" inputmode="numeric">
                    <span>—á–∞—Å–æ–≤</span>
                </div>
                <div class="cleaning-options">
                    <div class="cleaning-option none active" onclick="selectCleaning('none')">–ë–µ–∑ —É–±–æ—Ä–∫–∏</div>
                    <div class="cleaning-option cleaning" onclick="selectCleaning('cleaning')">üßπ –£–±–æ—Ä–∫–∞</div>
                    <div class="cleaning-option fullCleaning" onclick="selectCleaning('fullCleaning')">üßΩ –ü–æ–ª–Ω–∞—è</div>
                </div>
                <button class="save-work-btn" onclick="saveWorkShift()">‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>

            <div class="divider">‚Äî –∏–ª–∏ –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ ‚Äî</div>

            <div class="other-options">
                <div class="other-option shift-off" onclick="setDayType('off')">üè† –í—ã—Ö–æ–¥–Ω–æ–π</div>
                <div class="other-option shift-vacation" onclick="setDayType('vacation')">üèñÔ∏è –û—Ç–ø—É—Å–∫</div>
                <div class="other-option shift-sick" onclick="setDayType('sick')">üè• –ë–æ–ª—å–Ω–∏—á–Ω—ã–π</div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-danger" onclick="clearShift()">‚úñ –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API_URL = '';
        const DEFAULT_HOURS = 10;
        
        let currentUser = null;
        let token = null;
        let employees = [];
        let shifts = {};
        let currentDate = new Date();
        let selectedCell = null;
        let selectedCleaning = 'none';
        let isMobile = window.innerWidth <= 768;

        const monthNames = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
        const monthNamesShort = ['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];
        const dayNames = ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            initMonthPicker();
            window.addEventListener('resize', handleResize);
            handleResize();
        });

        function handleResize() {
            isMobile = window.innerWidth <= 768;
            if (!isMobile) {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('hidden-mobile'));
            }
        }

        async function checkAuth() {
            token = localStorage.getItem('token');
            if (!token) { showLogin(); return; }
            try {
                const res = await api('/api/auth/verify');
                currentUser = res.user;
                showApp();
            } catch (e) {
                localStorage.removeItem('token');
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.remove('active');
            document.getElementById('mobileTabs').style.display = 'none';
        }

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.add('active');
            if (isMobile) document.getElementById('mobileTabs').style.display = 'block';
            document.getElementById('userBadge').textContent = currentUser.name;
            loadData();
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            try {
                const res = await fetch(API_URL + '/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (!res.ok) {
                    errorDiv.textContent = data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
                    errorDiv.style.display = 'block';
                    return;
                }
                token = data.token;
                currentUser = data.user;
                localStorage.setItem('token', token);
                errorDiv.style.display = 'none';
                showApp();
            } catch (e) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                errorDiv.style.display = 'block';
            }
        });

        function logout() {
            localStorage.removeItem('token');
            token = null;
            currentUser = null;
            showLogin();
        }

        async function api(endpoint, options = {}) {
            const res = await fetch(API_URL + endpoint, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞');
            return data;
        }

        async function loadData() {
            try {
                [employees, shifts] = await Promise.all([
                    api('/api/employees'),
                    api('/api/shifts')
                ]);
                render();
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞: ' + e.message, true);
            }
        }

        async function addEmployee() {
            const input = document.getElementById('newEmployeeName');
            const name = input.value.trim();
            if (!name) return;
            try {
                const emp = await api('/api/employees', { method: 'POST', body: JSON.stringify({ name }) });
                employees.push(emp);
                input.value = '';
                render();
                showToast('‚úì ' + name);
            } catch (e) {
                showToast(e.message, true);
            }
        }

        async function deleteEmployee(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?')) return;
            try {
                await api('/api/employees/' + id, { method: 'DELETE' });
                employees = employees.filter(e => e.id !== id);
                Object.keys(shifts).filter(k => k.startsWith(id + '_')).forEach(k => delete shifts[k]);
                render();
                showToast('–£–¥–∞–ª–µ–Ω–æ');
            } catch (e) {
                showToast(e.message, true);
            }
        }

        document.getElementById('newEmployeeName').addEventListener('keypress', e => {
            if (e.key === 'Enter') addEmployee();
        });

        async function saveShift(key, data) {
            try {
                await api('/api/shifts', { method: 'POST', body: JSON.stringify({ key, data }) });
                if (data === null) delete shifts[key];
                else shifts[key] = data;
                render();
            } catch (e) {
                showToast(e.message, true);
            }
        }

        async function saveWorkShift() {
            if (!selectedCell) return;
            const hours = parseInt(document.getElementById('modalHours').value) || DEFAULT_HOURS;
            const key = `${selectedCell.empId}_${selectedCell.year}-${selectedCell.month}-${selectedCell.day}`;
            await saveShift(key, { type: 'work', hours, cleaning: selectedCleaning === 'none' ? null : selectedCleaning });
            closeModal();
        }

        async function setDayType(type) {
            if (!selectedCell) return;
            const key = `${selectedCell.empId}_${selectedCell.year}-${selectedCell.month}-${selectedCell.day}`;
            await saveShift(key, { type });
            closeModal();
        }

        async function clearShift() {
            if (!selectedCell) return;
            const key = `${selectedCell.empId}_${selectedCell.year}-${selectedCell.month}-${selectedCell.day}`;
            await saveShift(key, null);
            closeModal();
        }

        function render() {
            renderEmployeeList();
            renderCalendar();
            renderStats();
        }

        function renderEmployeeList() {
            const list = document.getElementById('employeeList');
            if (!employees.length) {
                list.innerHTML = '<p style="color:#888;text-align:center;padding:20px;font-size:1rem">–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>';
                return;
            }
            list.innerHTML = employees.map(e => `
                <div class="employee-item">
                    <div class="employee-info">
                        <div class="employee-color" style="background:${e.color}"></div>
                        <span>${e.name}</span>
                    </div>
                    <button class="delete-btn" onclick="deleteEmployee('${e.id}')">√ó</button>
                </div>
            `).join('');
        }

        function initMonthPicker() {
            const picker = document.getElementById('monthPicker');
            picker.value = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            picker.addEventListener('change', function() {
                const [y, m] = this.value.split('-');
                currentDate = new Date(y, m - 1, 1);
                render();
            });
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            document.getElementById('monthPicker').value = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            render();
        }

        function getDaysInMonth(y, m) { return new Date(y, m + 1, 0).getDate(); }
        function getDayOfWeek(y, m, d) { return new Date(y, m, d).getDay(); }

        function getShiftDisplay(data) {
            if (!data) return { label: '', class: '' };
            if (data.type === 'work') {
                let label = data.hours.toString();
                let cls = 'shift-work';
                if (data.cleaning === 'cleaning') { label += '/–£'; cls = 'shift-work-cleaning'; }
                else if (data.cleaning === 'fullCleaning') { label += '/–£1'; cls = 'shift-work-fullCleaning'; }
                return { label, class: cls };
            }
            const map = {
                'off': { label: '–í', class: 'shift-off' },
                'vacation': { label: '–û', class: 'shift-vacation' },
                'sick': { label: '–ë', class: 'shift-sick' }
            };
            return map[data.type] || { label: '', class: '' };
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const days = getDaysInMonth(year, month);
            const today = new Date();

            document.getElementById('currentMonthDisplay').textContent = `${monthNames[month]} ${year}`;

            let head = '<tr><th>–ò–º—è</th>';
            for (let d = 1; d <= days; d++) {
                const dow = getDayOfWeek(year, month, d);
                const isWeekend = dow === 0 || dow === 6;
                const isToday = today.getDate() === d && today.getMonth() === month && today.getFullYear() === year;
                head += `<th class="${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}">${d}<br><small>${dayNames[dow]}</small></th>`;
            }
            head += '<th>Œ£</th></tr>';
            document.getElementById('tableHead').innerHTML = head;

            if (!employees.length) {
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="${days + 2}" style="text-align:center;padding:30px;color:#888;font-size:1rem">–î–æ–±–∞–≤—å—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</td></tr>`;
                return;
            }

            let body = '';
            employees.forEach(emp => {
                body += `<tr><td class="employee-name"><span style="color:${emp.color}">‚óè</span> ${emp.name}</td>`;
                let total = 0;
                for (let d = 1; d <= days; d++) {
                    const dow = getDayOfWeek(year, month, d);
                    const isWeekend = dow === 0 || dow === 6;
                    const isToday = today.getDate() === d && today.getMonth() === month && today.getFullYear() === year;
                    const key = `${emp.id}_${year}-${month}-${d}`;
                    const shift = shifts[key];
                    const disp = getShiftDisplay(shift);
                    if (shift?.type === 'work') total += shift.hours;
                    body += `<td class="shift-cell ${disp.class} ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}" 
                        onclick="openShiftModal('${emp.id}',${year},${month},${d})">${disp.label}</td>`;
                }
                body += `<td class="total-cell">${total}</td></tr>`;
            });
            document.getElementById('tableBody').innerHTML = body;
        }

        function renderStats() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const days = getDaysInMonth(year, month);
            
            let totals = { hours: 0, shifts: 0, cleaning: 0, fullCleaning: 0 };
            let rows = '';
            
            employees.forEach(emp => {
                let s = { hours: 0, shifts: 0, cleaning: 0, fullCleaning: 0, off: 0, vacation: 0, sick: 0 };
                for (let d = 1; d <= days; d++) {
                    const shift = shifts[`${emp.id}_${year}-${month}-${d}`];
                    if (shift) {
                        if (shift.type === 'work') {
                            s.hours += shift.hours;
                            s.shifts++;
                            if (shift.cleaning === 'cleaning') s.cleaning++;
                            else if (shift.cleaning === 'fullCleaning') s.fullCleaning++;
                        } else s[shift.type]++;
                    }
                }
                totals.hours += s.hours;
                totals.shifts += s.shifts;
                totals.cleaning += s.cleaning;
                totals.fullCleaning += s.fullCleaning;
                
                rows += `<tr>
                    <td><span style="color:${emp.color}">‚óè</span> ${emp.name}</td>
                    <td><strong>${s.shifts}</strong></td>
                    <td><strong>${s.hours}</strong></td>
                    <td>${s.cleaning || '-'}</td>
                    <td>${s.fullCleaning || '-'}</td>
                    <td>${s.off || '-'}</td>
                    <td>${s.vacation || '-'}</td>
                    <td>${s.sick || '-'}</td>
                </tr>`;
            });
            
            document.getElementById('statsTableBody').innerHTML = rows;
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card"><h3>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h3><div class="value">${employees.length}</div></div>
                <div class="stat-card"><h3>–°–º–µ–Ω</h3><div class="value">${totals.shifts}</div></div>
                <div class="stat-card"><h3>–ß–∞—Å–æ–≤</h3><div class="value">${totals.hours}</div></div>
                <div class="stat-card"><h3>–£–±–æ—Ä–æ–∫</h3><div class="value">${totals.cleaning}</div></div>
                <div class="stat-card"><h3>–ü–æ–ª–Ω—ã—Ö</h3><div class="value">${totals.fullCleaning}</div></div>
                <div class="stat-card"><h3>–°—Ä. —á–∞—Å–æ–≤</h3><div class="value">${employees.length ? Math.round(totals.hours / employees.length) : 0}</div></div>
            `;
        }

        function selectCleaning(type) {
            selectedCleaning = type;
            document.querySelectorAll('.cleaning-option').forEach(el => el.classList.remove('active'));
            document.querySelector(`.cleaning-option.${type === 'none' ? 'none' : type}`).classList.add('active');
        }

        function openShiftModal(empId, year, month, day) {
            selectedCell = { empId, year, month, day };
            const emp = employees.find(e => e.id === empId);
            document.getElementById('modalInfo').textContent = `${emp.name} ‚Äî ${day} ${monthNamesShort[month]} ${year}`;
            
            const key = `${empId}_${year}-${month}-${day}`;
            const shift = shifts[key];
            
            if (shift?.type === 'work') {
                document.getElementById('modalHours').value = shift.hours;
                selectCleaning(shift.cleaning || 'none');
            } else {
                document.getElementById('modalHours').value = DEFAULT_HOURS;
                selectCleaning('none');
            }
            
            document.getElementById('shiftModal').classList.add('active');
            setTimeout(() => document.getElementById('modalHours').select(), 150);
        }

        function closeModal() {
            document.getElementById('shiftModal').classList.remove('active');
            selectedCell = null;
        }

        document.getElementById('shiftModal').addEventListener('click', e => {
            if (e.target.id === 'shiftModal') closeModal();
        });

        document.getElementById('modalHours').addEventListener('keypress', e => {
            if (e.key === 'Enter') { e.preventDefault(); saveWorkShift(); }
        });

        function showSection(section) {
            if (!isMobile) return;
            document.querySelectorAll('.mobile-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden-mobile'));
            const map = { calendar: 'sectionCalendar', employees: 'sectionEmployees', stats: 'sectionStats' };
            document.getElementById(map[section]).classList.remove('hidden-mobile');
            document.querySelector(`.mobile-tab[onclick="showSection('${section}')"]`).classList.add('active');
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        function exportToExcel() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const days = getDaysInMonth(year, month);
            const wb = XLSX.utils.book_new();

            const data = [[`–ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω - ${monthNames[month]} ${year}`], []];
            const header = ['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'];
            for (let d = 1; d <= days; d++) header.push(`${d} ${dayNames[getDayOfWeek(year, month, d)]}`);
            header.push('–ß–∞—Å–æ–≤');
            data.push(header);

            employees.forEach(emp => {
                const row = [emp.name];
                let total = 0;
                for (let d = 1; d <= days; d++) {
                    const shift = shifts[`${emp.id}_${year}-${month}-${d}`];
                    row.push(getShiftDisplay(shift).label);
                    if (shift?.type === 'work') total += shift.hours;
                }
                row.push(total);
                data.push(row);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 20 }, ...Array(days).fill({ wch: 6 }), { wch: 8 }];
            XLSX.utils.book_append_sheet(wb, ws, '–ì—Ä–∞—Ñ–∏–∫');
            XLSX.writeFile(wb, `–°–º–µ–Ω—ã_${monthNamesShort[month]}_${year}.xlsx`);
            showToast('üìä –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
    </script>
</body>
</html>
